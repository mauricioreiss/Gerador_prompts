<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Prompts para IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Modal Colar Respostas -->
    <div id="pasteModal" class="modal items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="font-semibold text-gray-800">Colar Respostas do Google Forms</h2>
                <button onclick="closePasteModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <textarea id="pasteArea" rows="15" class="w-full px-3 py-2 border rounded-md font-mono text-sm" placeholder="Cole aqui as respostas do Google Forms...

Exemplo:
Nome da Empresa
*
Adap Locações

Nome do Atendente: Qual nome a IA deve usar?
Ana
..."></textarea>
                <button onclick="processarRespostas()" class="mt-4 w-full py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                    <i class="fas fa-magic mr-2"></i>Preencher Formulário
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white shadow-sm mb-6">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Gerador de Prompts</h1>
            <div class="flex gap-2">
                <button onclick="openPasteModal()" class="px-4 py-2 rounded-lg text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200">
                    <i class="fas fa-paste mr-2"></i>Colar Respostas
                </button>
                <button onclick="showTab('form')" id="btn-form" class="px-4 py-2 rounded-lg text-sm font-medium tab-active">
                    <i class="fas fa-plus mr-2"></i>Novo Prompt
                </button>
                <button onclick="showTab('list')" id="btn-list" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">
                    <i class="fas fa-list mr-2"></i>Prompts Salvos
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Tab: Formulário -->
        <div id="tab-form">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Formulário -->
                <div class="space-y-4">
                    <form id="promptForm" class="space-y-4">
                        <!-- Seção 1 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="font-semibold text-gray-800 mb-4 pb-2 border-b">1) Identidade</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label>
                                    <input type="text" name="nome_empresa" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Atendente</label>
                                    <input type="text" name="nome_atendente" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tom de Voz</label>
                                    <input type="text" name="estilo_comunicacao" class="w-full px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Estilo de Mensagem</label>
                                    <input type="text" name="regras_comunicacao" class="w-full px-3 py-2 border rounded-md">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Papel da IA</label>
                                    <input type="text" name="papel_ia" class="w-full px-3 py-2 border rounded-md" value="atender clientes, tirar dúvidas e direcionar para o atendimento humano">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Limitações/Proibições</label>
                                    <textarea name="proibicoes_texto" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 2 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                                <h2 class="font-semibold text-gray-800">2) Menu Inicial</h2>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="possui_menu" checked class="w-4 h-4 rounded">
                                    Incluir menu
                                </label>
                            </div>
                            <div id="menuSection">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mensagem de Boas-vindas</label>
                                    <textarea name="mensagem_boas_vindas" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Opções do Menu</label>
                                    <textarea name="menu_opcoes" rows="3" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Triagem Automática (ir direto para humano)</label>
                                    <input type="text" name="opcoes_transbordo_imediato" class="w-full px-3 py-2 border rounded-md">
                                </div>
                            </div>
                        </div>

                        <!-- Seção 3 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="font-semibold text-gray-800 mb-4 pb-2 border-b">3) Contexto da Empresa</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contexto/Autoridade</label>
                                    <textarea name="frase_autoridade" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lista de Serviços</label>
                                    <textarea name="servicos_lista" rows="3" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                                        <textarea name="endereco" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Horário</label>
                                        <input type="text" name="horario_funcionamento" class="w-full px-3 py-2 border rounded-md">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 4 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="font-semibold text-gray-800 mb-4 pb-2 border-b">4) Regras de Negócio</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Regra de Preço</label>
                                    <input type="text" name="regra_preco_texto" class="w-full px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nível Técnico (marcas)</label>
                                    <input type="text" name="regra_marcas_texto" class="w-full px-3 py-2 border rounded-md">
                                </div>
                            </div>
                        </div>

                        <!-- Seção 5 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="font-semibold text-gray-800 mb-4 pb-2 border-b">5) Catálogo</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Produtos/Serviços</label>
                                    <textarea name="produtos_lista" rows="3" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tabela de Preços</label>
                                    <textarea name="tabela_precos" rows="3" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Itens Adicionais</label>
                                    <input type="text" name="itens_adicionais" class="w-full px-3 py-2 border rounded-md">
                                </div>
                            </div>
                        </div>

                        <!-- Seção 6 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="font-semibold text-gray-800 mb-4 pb-2 border-b">6) Fluxo de Atendimento</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Passo a Passo / Sondagem</label>
                                    <textarea name="frase_sondagem" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Qualificação / Experiência</label>
                                    <textarea name="pergunta_experiencia" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Documentação necessária</label>
                                    <textarea name="texto_documentacao" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 7 -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                                <h2 class="font-semibold text-gray-800">7) Tratamento de Objeções</h2>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="possui_objecoes" class="w-4 h-4 rounded">
                                    Incluir objeções
                                </label>
                            </div>
                            <div id="objecoesSection" class="space-y-4 hidden">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Objeção de Preço</label>
                                    <textarea name="texto_objecoes" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Dúvida Técnica</label>
                                    <textarea name="texto_duvida_tecnica" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações -->
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h2 class="font-semibold text-gray-800 mb-4 pb-2 border-b">Configurações</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Team ID</label>
                                    <input type="text" name="team_id" class="w-full px-3 py-2 border rounded-md" value="1">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-magic mr-2"></i>Gerar Prompt
                        </button>
                    </form>
                </div>

                <!-- Resultado -->
                <div class="space-y-4">
                    <div class="bg-white rounded-lg shadow overflow-hidden sticky top-4">
                        <div class="flex items-center justify-between p-4 border-b bg-gray-50">
                            <h2 class="font-semibold text-gray-800">Prompt Gerado</h2>
                            <div class="flex gap-2">
                                <button onclick="toggleView()" id="viewToggle" class="px-3 py-1 text-sm bg-gray-200 rounded-lg">
                                    <i class="fas fa-eye mr-1"></i>Preview
                                </button>
                                <button onclick="copyPrompt()" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                                    <i class="fas fa-copy mr-1"></i>Copiar
                                </button>
                            </div>
                        </div>
                        <div id="promptResult" class="p-4 max-h-[600px] overflow-y-auto">
                            <div class="text-gray-400 text-center py-12">
                                <i class="fas fa-file-alt text-4xl mb-4"></i>
                                <p>Preencha o formulário e clique em "Gerar Prompt"</p>
                            </div>
                        </div>
                    </div>

                    <!-- Refinar com IA -->
                    <div id="refineSection" class="bg-white rounded-lg shadow overflow-hidden hidden">
                        <div class="p-4 border-b bg-purple-50">
                            <h3 class="font-semibold text-purple-800"><i class="fas fa-robot mr-2"></i>Refinar com IA</h3>
                        </div>
                        <div class="p-4">
                            <div class="flex gap-2">
                                <input type="text" id="refineInput" class="flex-1 px-3 py-2 border rounded-md" placeholder='Ex: "adicione regra sobre horário de almoço"'>
                                <button onclick="refinePrompt()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                    Refinar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Lista de Prompts -->
        <div id="tab-list" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-4 border-b bg-gray-50">
                        <h2 class="font-semibold text-gray-800">Clientes</h2>
                    </div>
                    <div id="promptsList" class="max-h-[600px] overflow-y-auto">
                        <div class="p-8 text-center text-gray-400">Carregando...</div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="flex items-center justify-between p-4 border-b bg-gray-50">
                            <h2 id="selectedClient" class="font-semibold text-gray-800">Selecione um cliente</h2>
                            <div class="flex gap-2">
                                <button onclick="toggleEditMode()" id="editToggle" class="px-3 py-1 text-sm bg-gray-200 rounded-lg hidden">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="savePrompt()" id="saveBtn" class="px-3 py-1 text-sm bg-green-600 text-white rounded-lg hidden">
                                    <i class="fas fa-save mr-1"></i>Salvar
                                </button>
                                <button onclick="copySelectedPrompt()" id="copyBtn" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hidden">
                                    <i class="fas fa-copy mr-1"></i>Copiar
                                </button>
                            </div>
                        </div>
                        <div id="selectedPromptContent" class="p-4 max-h-[500px] overflow-y-auto">
                            <div class="text-gray-400 text-center py-12">
                                <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                                <p>Clique em um cliente para ver o prompt</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let currentPrompt = '';
        let selectedFilename = '';
        let isMarkdownView = true;
        let isEditMode = false;

        // Mapeamento das perguntas do Google Forms para os campos do formulário
        const MAPEAMENTO = {
            "Nome da Empresa": "nome_empresa",
            "Nome do Atendente: Qual nome a IA deve usar?": "nome_atendente",
            "Tom de Voz: Deve ser formal, descontraído, consultivo ou focado em vendas?": "estilo_comunicacao",
            "Limitações de Escrita: Existem termos proibidos (ex: nomes de marcas, \"formalês\")?": "proibicoes_texto",
            "Estilo de Mensagem: Prefere parágrafos curtos, uso de emojis ou texto corrido?": "regras_comunicacao",
            "Mensagem de Boas-Vindas: Como a IA deve se apresentar no primeiro contato?": "mensagem_boas_vindas",
            "Opções do Menu: Quais são os caminhos principais que o cliente pode escolher (ex: 1. Orçamento, 2. Suporte)?": "menu_opcoes",
            "Triagem Automática: Quais opções devem ser enviadas diretamente para um humano sem passar pela IA?": "opcoes_transbordo_imediato",
            "Contexto da Empresa: Há quanto tempo está no mercado? Qual o diferencial principal?": "frase_autoridade",
            "Lista de Serviços: Além do serviço principal, o que mais a empresa oferece (venda, manutenção, serviços)?": "servicos_lista",
            "Localização e Horários: Endereço físico e horários de funcionamento para consulta da IA.": "localizacao_horarios",
            "Regra de Preço: A IA pode falar preços abertamente ou apenas se o cliente perguntar?": "regra_preco_texto",
            "Nível Técnico: A IA deve usar nomes de marcas ou focar apenas na solução/equipamento?": "regra_marcas_texto",
            "Produtos/Serviços: Quais os itens disponíveis?": "produtos_lista",
            "Tabela de Preços: Quais os valores para diária, semana, quinzena e mês?": "tabela_precos",
            "Itens Adicionais: Existem consumíveis ou acessórios que podem ser vendidos junto (ex: lixas)?": "itens_adicionais",
            "Passo a Passo: Qual a ordem ideal das perguntas (ex: 1. Projeto -> 2. Experiência -> 3. Data -> 4. Cadastro)?": "frase_sondagem",
            "Qualificação: O que a IA precisa saber antes de passar para o vendedor (ex: tipo de tinta, se já tem cadastro)?": "texto_documentacao",
            "Preço: O que a IA deve responder se o cliente disser que está caro?": "texto_objecoes",
            "Dúvida Técnica: Como a IA deve agir se o cliente não souber qual equipamento escolher?": "texto_duvida_tecnica",
        };

        // Modal functions
        function openPasteModal() {
            document.getElementById('pasteModal').classList.add('active');
        }

        function closePasteModal() {
            document.getElementById('pasteModal').classList.remove('active');
        }

        function processarRespostas() {
            const texto = document.getElementById('pasteArea').value;
            if (!texto.trim()) {
                alert('Cole as respostas primeiro!');
                return;
            }

            const dados = parseRespostas(texto);
            preencherFormulario(dados);
            closePasteModal();
            alert('Formulário preenchido! Revise e clique em "Gerar Prompt"');
        }

        function parseRespostas(texto) {
            const dados = {};
            const linhas = texto.split('\n');
            let perguntaAtual = null;
            let respostaAtual = [];

            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i].trim();

                // Pula linhas vazias e asteriscos
                if (linha === '' || linha === '*') {
                    if (perguntaAtual && respostaAtual.length > 0) {
                        const campo = MAPEAMENTO[perguntaAtual];
                        if (campo) {
                            dados[campo] = respostaAtual.join('\n').trim();
                        }
                        respostaAtual = [];
                    }
                    continue;
                }

                // Verifica se é uma pergunta conhecida
                let ehPergunta = false;
                for (const pergunta of Object.keys(MAPEAMENTO)) {
                    if (linha.startsWith(pergunta.substring(0, 25)) || pergunta.startsWith(linha.substring(0, 25))) {
                        if (perguntaAtual && respostaAtual.length > 0) {
                            const campo = MAPEAMENTO[perguntaAtual];
                            if (campo) {
                                dados[campo] = respostaAtual.join('\n').trim();
                            }
                        }
                        perguntaAtual = pergunta;
                        respostaAtual = [];
                        ehPergunta = true;
                        break;
                    }
                }

                // Se não é pergunta, é parte da resposta
                if (!ehPergunta && perguntaAtual) {
                    // Ignora cabeçalhos de seção
                    if (!linha.match(/^(Porta de Entrada|Quem somos|Regras de Negócio|Catálogo e Valores|Fluxo Lógico|Tratamento de Objeções)/i)) {
                        respostaAtual.push(linha);
                    }
                }
            }

            // Salva a última resposta
            if (perguntaAtual && respostaAtual.length > 0) {
                const campo = MAPEAMENTO[perguntaAtual];
                if (campo) {
                    dados[campo] = respostaAtual.join('\n').trim();
                }
            }

            return dados;
        }

        function preencherFormulario(dados) {
            const form = document.getElementById('promptForm');

            // Processa localização e horários
            if (dados.localizacao_horarios) {
                const texto = dados.localizacao_horarios;
                const match = texto.match(/(\d{1,2}[Hh].*)/);
                if (match) {
                    const idx = texto.indexOf(match[0]);
                    dados.endereco = texto.substring(0, idx).trim();
                    dados.horario_funcionamento = match[0].trim();
                } else {
                    dados.endereco = texto;
                }
            }

            // Preenche cada campo
            for (const [campo, valor] of Object.entries(dados)) {
                const input = form.querySelector(`[name="${campo}"]`);
                if (input) {
                    input.value = valor;
                }
            }

            // Ativa checkbox de objeções se tiver texto
            if (dados.texto_objecoes || dados.texto_duvida_tecnica) {
                form.querySelector('[name="possui_objecoes"]').checked = true;
                document.getElementById('objecoesSection').classList.remove('hidden');
            }

            // Define pergunta_experiencia a partir de texto_documentacao se não existir
            if (!dados.pergunta_experiencia && dados.texto_documentacao) {
                form.querySelector('[name="pergunta_experiencia"]').value = dados.texto_documentacao;
            }
        }

        // Toggle sections
        document.querySelector('[name="possui_menu"]').addEventListener('change', function() {
            document.getElementById('menuSection').classList.toggle('hidden', !this.checked);
        });

        document.querySelector('[name="possui_objecoes"]').addEventListener('change', function() {
            document.getElementById('objecoesSection').classList.toggle('hidden', !this.checked);
        });

        // Tabs
        function showTab(tab) {
            document.getElementById('tab-form').classList.toggle('hidden', tab !== 'form');
            document.getElementById('tab-list').classList.toggle('hidden', tab !== 'list');
            document.getElementById('btn-form').classList.toggle('tab-active', tab === 'form');
            document.getElementById('btn-list').classList.toggle('tab-active', tab === 'list');
            document.getElementById('btn-form').classList.toggle('text-gray-600', tab !== 'form');
            document.getElementById('btn-list').classList.toggle('text-gray-600', tab !== 'list');
            if (tab === 'list') loadPromptsList();
        }

        // Form submit
        document.getElementById('promptForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            const data = {
                nome_empresa: formData.get('nome_empresa'),
                nome_atendente: formData.get('nome_atendente'),
                papel_ia: formData.get('papel_ia'),
                estilo_comunicacao: formData.get('estilo_comunicacao'),
                proibicoes_texto: formData.get('proibicoes_texto') || 'Nunca pareça uma IA',
                possui_menu: formData.get('possui_menu') === 'on',
                mensagem_boas_vindas: formData.get('mensagem_boas_vindas'),
                menu_opcoes: formData.get('menu_opcoes')?.split('\n').filter(x => x.trim()) || [],
                frase_autoridade: formData.get('frase_autoridade'),
                servicos_lista: formData.get('servicos_lista')?.split(/[,\n]/).filter(x => x.trim()) || [],
                endereco: formData.get('endereco'),
                horario_funcionamento: formData.get('horario_funcionamento'),
                regra_marcas_texto: formData.get('regra_marcas_texto'),
                regra_preco_texto: formData.get('regra_preco_texto'),
                produtos_catalogo: formData.get('produtos_lista') ? [{
                    nome: formData.get('produtos_lista'),
                    precos: formData.get('tabela_precos') || ''
                }] : [],
                frase_sondagem: formData.get('frase_sondagem'),
                pergunta_experiencia: formData.get('pergunta_experiencia'),
                texto_documentacao: formData.get('texto_documentacao'),
                possui_objecoes: formData.get('possui_objecoes') === 'on',
                texto_objecoes: formData.get('texto_objecoes'),
                opcoes_transbordo_imediato: formData.get('opcoes_transbordo_imediato'),
                team_id: formData.get('team_id') || '1',
            };

            try {
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Erro ao gerar');
                }

                const result = await res.json();
                currentPrompt = result.prompt;
                renderPrompt();
                document.getElementById('refineSection').classList.remove('hidden');
            } catch (err) {
                alert('Erro ao gerar prompt: ' + err.message);
            }
        });

        function renderPrompt() {
            const el = document.getElementById('promptResult');
            if (isMarkdownView) {
                el.innerHTML = `<pre class="whitespace-pre-wrap text-sm font-mono bg-gray-50 p-4 rounded">${escapeHtml(currentPrompt)}</pre>`;
            } else {
                el.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(currentPrompt)}</div>`;
            }
        }

        function toggleView() {
            isMarkdownView = !isMarkdownView;
            document.getElementById('viewToggle').innerHTML = isMarkdownView
                ? '<i class="fas fa-eye mr-1"></i>Preview'
                : '<i class="fas fa-code mr-1"></i>Markdown';
            renderPrompt();
        }

        function copyPrompt() {
            navigator.clipboard.writeText(currentPrompt);
            alert('Copiado!');
        }

        async function refinePrompt() {
            const instrucao = document.getElementById('refineInput').value;
            if (!instrucao.trim()) return;

            try {
                const res = await fetch('/refine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt_atual: currentPrompt, instrucao })
                });
                const result = await res.json();
                currentPrompt = result.prompt_refinado;
                renderPrompt();
                document.getElementById('refineInput').value = '';
            } catch (err) {
                alert('Erro ao refinar: ' + err.message);
            }
        }

        // Lista de prompts
        async function loadPromptsList() {
            try {
                const res = await fetch('/prompts');
                const data = await res.json();
                const el = document.getElementById('promptsList');

                if (data.prompts.length === 0) {
                    el.innerHTML = '<div class="p-8 text-center text-gray-400">Nenhum prompt salvo</div>';
                    return;
                }

                el.innerHTML = data.prompts.map(p => `
                    <button onclick="loadPrompt('${p.filename}')" class="w-full px-4 py-3 text-left hover:bg-gray-50 border-b">
                        <div class="font-medium text-gray-800">${extractName(p.filename)}</div>
                        <div class="text-sm text-gray-500">${formatDate(p.created_at)}</div>
                    </button>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function loadPrompt(filename) {
            try {
                const res = await fetch(`/prompts/${filename}`);
                const data = await res.json();
                selectedFilename = filename;
                currentPrompt = data.content;

                document.getElementById('selectedClient').textContent = extractName(filename);
                document.getElementById('selectedPromptContent').innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(data.content)}</div>`;
                document.getElementById('editToggle').classList.remove('hidden');
                document.getElementById('copyBtn').classList.remove('hidden');
                isEditMode = false;
            } catch (err) {
                console.error(err);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const el = document.getElementById('selectedPromptContent');
            const saveBtn = document.getElementById('saveBtn');

            if (isEditMode) {
                el.innerHTML = `<textarea id="editArea" class="w-full h-[450px] p-2 border rounded font-mono text-sm">${escapeHtml(currentPrompt)}</textarea>`;
                saveBtn.classList.remove('hidden');
                document.getElementById('editToggle').innerHTML = '<i class="fas fa-eye mr-1"></i>Preview';
            } else {
                el.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(currentPrompt)}</div>`;
                saveBtn.classList.add('hidden');
                document.getElementById('editToggle').innerHTML = '<i class="fas fa-edit mr-1"></i>Editar';
            }
        }

        async function savePrompt() {
            const content = document.getElementById('editArea').value;
            try {
                await fetch(`/prompts/${selectedFilename}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                currentPrompt = content;
                toggleEditMode();
                alert('Salvo!');
            } catch (err) {
                alert('Erro ao salvar');
            }
        }

        function copySelectedPrompt() {
            navigator.clipboard.writeText(currentPrompt);
            alert('Copiado!');
        }

        function extractName(filename) {
            const parts = filename.replace('.md', '').split('_');
            return parts.length > 2 ? parts.slice(2).join(' ') : filename;
        }

        function formatDate(ts) {
            return new Date(ts * 1000).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
